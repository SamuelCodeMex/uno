<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>SPA Responsiva con API y CRUD</title>
  <style>
    /* ====== GRID SYSTEM ====== */
    .row { display: grid; grid-template-columns: repeat(12, 1fr); gap: 1rem; }
    .col { grid-column: span 12; }
    @media (min-width: 576px) { .col-sm-6 { grid-column: span 6; } .col-sm-4 { grid-column: span 4; } }
    @media (min-width: 768px) { .col-md-6 { grid-column: span 6; } .col-md-4 { grid-column: span 4; } }
    @media (min-width: 992px) { .col-lg-6 { grid-column: span 6; } .col-lg-4 { grid-column: span 4; } }
    @media (min-width: 1200px) { .col-xl-6 { grid-column: span 6; } .col-xl-4 { grid-column: span 4; } }
    @media (min-width: 1400px) { .col-xxl-6 { grid-column: span 6; } .col-xxl-4 { grid-column: span 4; } }

    /* ====== GENERAL STYLES ====== */
    body { font-family: Arial, sans-serif; margin: 0; }
    nav { background: #333; color: #fff; padding: 1rem; display: flex; flex-wrap: wrap; gap: 1rem; position: sticky; top: 0; z-index: 10; }
    nav a { color: #fff; text-decoration: none; cursor: pointer; }
    nav a:hover { text-decoration: underline; }

    section { display: none; padding: 2rem; min-height: 100vh; }
    section.active { display: block; }

    .demo { background: #eee; border: 1px solid #ccc; padding: 1rem; text-align: center; font-weight: bold; }

    .table-responsive { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; min-width: 420px; }
    table, th, td { border: 1px solid #ccc; }
    th, td { padding: 0.5rem; text-align: left; }
    caption { text-align: left; padding: 0.5rem 0; font-weight: bold; }

    @media (max-width: 576px) {
      table th, table td { font-size: 0.85rem; padding: 0.35rem; }
      nav { gap: 0.5rem; }
    }

    .loader { text-align: center; padding: 1rem; color: #666; }
    .btn { padding: 0.35rem 0.7rem; margin: 0.2rem; cursor: pointer; border: none; border-radius: 4px; }
    .btn-edit { background: #ffc107; }
    .btn-delete { background: #dc3545; color: #fff; }
    .btn-add { background: #28a745; color: #fff; margin-top: 0.5rem; }
    .controls { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem; }
    input[type="text"], input[type="email"] { padding: 0.35rem; border: 1px solid #ccc; border-radius: 4px; }
    .status { font-size: 0.9rem; color: #555; margin-top: 0.5rem; min-height: 1.2em; }
  </style>
</head>
<body>
  <!-- ====== NAVIGATION ====== -->
  <nav>
    <a data-section="quienes">Quienes Somos</a>
    <a data-section="valores">Nuestros Valores</a>
    <a data-section="contacto">Contacto</a>
    <a data-section="portafolio">Portafolio</a>
  </nav>

  <!-- ====== SECTIONS ====== -->
  <section id="quienes" class="active">
    <h2>Quienes Somos</h2>
    <p class="status" id="status-quienes"></p>
    <div class="content"></div>
    <div class="loader">Despl√°zate para cargar m√°s...</div>

    <div class="controls">
      <input id="quienes-name" type="text" placeholder="Nombre"/>
      <input id="quienes-email" type="email" placeholder="Email"/>
      <button class="btn btn-add" data-action="add" data-section="quienes">‚ûï Agregar Usuario</button>
    </div>

    <div class="table-responsive">
      <table id="table-quienes">
        <caption>Usuarios (API: /users)</caption>
        <thead><tr><th>ID</th><th>Nombre</th><th>Email</th><th>Acciones</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <section id="valores">
    <h2>Nuestros Valores</h2>
    <p class="status" id="status-valores"></p>
    <div class="content"></div>
    <div class="loader">Despl√°zate para cargar m√°s...</div>

    <div class="controls">
      <input id="valores-title" type="text" placeholder="T√≠tulo"/>
      <input id="valores-body" type="text" placeholder="Descripci√≥n"/>
      <button class="btn btn-add" data-action="add" data-section="valores">‚ûï Agregar Valor</button>
    </div>

    <div class="table-responsive">
      <table id="table-valores">
        <caption>Valores (API: /posts)</caption>
        <thead><tr><th>ID</th><th>T√≠tulo</th><th>Descripci√≥n</th><th>Acciones</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <section id="contacto">
    <h2>Contacto</h2>
    <p class="status" id="status-contacto"></p>
    <div class="content"></div>
    <div class="loader">Despl√°zate para cargar m√°s...</div>

    <div class="controls">
      <input id="contacto-name" type="text" placeholder="Nombre"/>
      <input id="contacto-phone" type="text" placeholder="Tel√©fono"/>
      <button class="btn btn-add" data-action="add" data-section="contacto">‚ûï Agregar Contacto</button>
    </div>

    <div class="table-responsive">
      <table id="table-contacto">
        <caption>Contactos (API: /users)</caption>
        <thead><tr><th>ID</th><th>Nombre</th><th>Tel√©fono</th><th>Acciones</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <section id="portafolio">
    <h2>Portafolio</h2>
    <p class="status" id="status-portafolio"></p>
    <div class="content"></div>
    <div class="loader">Despl√°zate para cargar m√°s...</div>

    <div class="controls">
      <input id="portafolio-title" type="text" placeholder="Proyecto"/>
      <input id="portafolio-state" type="text" placeholder="Estado (Finalizado/Pendiente)"/>
      <button class="btn btn-add" data-action="add" data-section="portafolio">‚ûï Agregar Proyecto</button>
    </div>

    <div class="table-responsive">
      <table id="table-portafolio">
        <caption>Proyectos (API: /todos)</caption>
        <thead><tr><th>ID</th><th>Proyecto</th><th>Estado</th><th>Acciones</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- ====== SCRIPT SPA + LAZY + API CRUD ====== -->
  <script>
    const API = "https://jsonplaceholder.typicode.com";
    const observerBySection = new Map();

    // Navegaci√≥n SPA
    document.querySelectorAll("nav a").forEach(a => {
      a.addEventListener("click", () => showSection(a.dataset.section));
    });

    function showSection(id) {
      document.querySelectorAll("section").forEach(sec => sec.classList.remove("active"));
      const sec = document.getElementById(id);
      sec.classList.add("active");

      // Reset lazy content
      const content = sec.querySelector(".content");
      content.innerHTML = "";
      sec.dataset.page = "0";
      const loader = sec.querySelector(".loader");
      loader.textContent = "Despl√°zate para cargar m√°s...";

      // Configurar IntersectionObserver por secci√≥n
      setupObserverForSection(sec);

      // Cargar datos API
      loadAPIData(id);
    }

    // Configurar IntersectionObserver para cada secci√≥n activa
    function setupObserverForSection(sectionEl) {
      const loader = sectionEl.querySelector(".loader");

      // Desconectar observer anterior de la secci√≥n
      if (observerBySection.has(sectionEl.id)) {
        observerBySection.get(sectionEl.id).disconnect();
      }

      const io = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            loadMore(sectionEl);
          }
        });
      }, { root: null, rootMargin: "0px", threshold: 0.1 });

      io.observe(loader);
      observerBySection.set(sectionEl.id, io);

      // Primer bloque
      loadMore(sectionEl);
    }

    // Generar contenido simulado
    function generateContent(sectionId, page) {
      let html = '<div class="row">';
      for (let i = 1; i <= 3; i++) {
        html += `<div class="col col-sm-6 col-md-4 demo">${sectionId} - Bloque ${page*3+i}</div>`;
      }
      html += '</div>';
      html += `<div class="table-responsive"><table>
        <caption>Tabla de ejemplo (${sectionId}) - P√°gina ${page+1}</caption>
        <thead><tr><th>Columna A</th><th>Columna B</th><th>Columna C</th></tr></thead>
        <tbody>
          <tr><td>Dato ${page+1}.1</td><td>Dato ${page+1}.2</td><td>Dato ${page+1}.3</td></tr>
          <tr><td>Dato ${page+1}.4</td><td>Dato ${page+1}.5</td><td>Dato ${page+1}.6</td></tr>
        </tbody>
      </table></div>`;
      return html;
    }

    // Lazy loading por secciones (m√°ximo 5 p√°ginas)
    function loadMore(sec) {
      const current = parseInt(sec.dataset.page || "0", 10);
      if (current >= 5) {
        sec.querySelector(".loader").textContent = "Fin del contenido";
        return;
      }
      sec.querySelector(".content").insertAdjacentHTML("beforeend", generateContent(sec.id, current));
      sec.dataset.page = String(current + 1);
    }

    // Lectura de datos API seg√∫n secci√≥n
    async function loadAPIData(sectionId) {
      const statusEl = document.getElementById("status-" + sectionId);
      statusEl.textContent = "Cargando datos...";
      const { url, tableBody } = resolveEndpointAndTable(sectionId);

      tableBody.innerHTML = "<tr><td colspan='4'>Cargando...</td></tr>";
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        tableBody.innerHTML = "";
        data.slice(0, 5).forEach(item => tableBody.insertAdjacentHTML("beforeend", renderRow(sectionId, item)));
        statusEl.textContent = "Datos cargados (CRUD simulado).";
      } catch (e) {
        tableBody.innerHTML = "<tr><td colspan='4'>Error al cargar datos</td></tr>";
        statusEl.textContent = "Error al cargar: " + e.message;
      }
    }

    function resolveEndpointAndTable(sectionId) {
      if (sectionId === "quienes") {
        return { url: `${API}/users`, tableBody: document.querySelector("#table-quienes tbody") };
      }
      if (sectionId === "valores") {
        return { url: `${API}/posts`, tableBody: document.querySelector("#table-valores tbody") };
      }
      if (sectionId === "contacto") {
        return { url: `${API}/users`, tableBody: document.querySelector("#table-contacto tbody") };
      }
      if (sectionId === "portafolio") {
        return { url: `${API}/todos`, tableBody: document.querySelector("#table-portafolio tbody") };
      }
      return { url: API, tableBody: document.createElement("tbody") };
    }

    // Renderizar fila seg√∫n secci√≥n (sin reemplazar la fila completa al editar)
    function renderRow(sectionId, item) {
      if (sectionId === "quienes") {
        const id = item.id ?? "";
        const name = item.name ?? "";
        const email = item.email ?? "";
        return `<tr data-id="${id}">
          <td>${id}</td>
          <td contenteditable="true">${escapeHtml(name)}</td>
          <td contenteditable="true">${escapeHtml(email)}</td>
          <td>
            <button class="btn btn-edit" data-action="edit" data-section="${sectionId}" data-id="${id}">‚úèÔ∏è</button>
            <button class="btn btn-delete" data-action="delete" data-section="${sectionId}" data-id="${id}">üóëÔ∏è</button>
          </td>
        </tr>`;
      }
      if (sectionId === "valores") {
        const id = item.id ?? "";
        const title = item.title ?? "";
        const body = item.body ?? "";
        return `<tr data-id="${id}">
          <td>${id}</td>
          <td contenteditable="true">${escapeHtml(title)}</td>
          <td contenteditable="true">${escapeHtml(body)}</td>
          <td>
            <button class="btn btn-edit" data-action="edit" data-section="${sectionId}" data-id="${id}">‚úèÔ∏è</button>
            <button class="btn btn-delete" data-action="delete" data-section="${sectionId}" data-id="${id}">üóëÔ∏è</button>
          </td>
        </tr>`;
      }
      if (sectionId === "contacto") {
        const id = item.id ?? "";
        const name = item.name ?? "";
        const phone = (item.phone ?? "").toString();
        return `<tr data-id="${id}">
          <td>${id}</td>
          <td contenteditable="true">${escapeHtml(name)}</td>
          <td contenteditable="true">${escapeHtml(phone)}</td>
          <td>
            <button class="btn btn-edit" data-action="edit" data-section="${sectionId}" data-id="${id}">‚úèÔ∏è</button>
            <button class="btn btn-delete" data-action="delete" data-section="${sectionId}" data-id="${id}">üóëÔ∏è</button>
          </td>
        </tr>`;
      }
      if (sectionId === "portafolio") {
        const id = item.id ?? "";
        const title = item.title ?? `Proyecto ${id}`;
        const state = item.completed ? "Finalizado" : "Pendiente";
        return `<tr data-id="${id}">
          <td>${id}</td>
          <td contenteditable="true">${escapeHtml(title)}</td>
          <td contenteditable="true">${escapeHtml(state)}</td>
          <td>
            <button class="btn btn-edit" data-action="edit" data-section="${sectionId}" data-id="${id}">‚úèÔ∏è</button>
            <button class="btn btn-delete" data-action="delete" data-section="${sectionId}" data-id="${id}">üóëÔ∏è</button>
          </td>
        </tr>`;
      }
      return "";
    }

    // Delegaci√≥n de eventos para botones de CRUD
    document.body.addEventListener("click", async (e) => {
      const btn = e.target.closest("button");
      if (!btn) return;

      const action = btn.dataset.action;
      const sectionId = btn.dataset.section;

      // Create
      if (action === "add" && sectionId) {
        await addRow(sectionId);
        return;
      }

      // Update/Delete
      if ((action === "edit" || action === "delete") && sectionId) {
        const id = parseInt(btn.dataset.id, 10);
        if (isNaN(id)) return;
        if (action === "edit") await editRow(sectionId, id);
        else await deleteRow(sectionId, id);
      }
    });

    // CREATE
    async function addRow(sectionId) {
      const statusEl = document.getElementById("status-" + sectionId);
      let payload = {}, url = "", tableBody;

      if (sectionId === "quienes") {
        const name = document.getElementById("quienes-name").value.trim();
        const email = document.getElementById("quienes-email").value.trim();
        if (!name || !email) { alert("Completa nombre y email."); return; }
        payload = { name, email };
        url = `${API}/users`;
        tableBody = document.querySelector("#table-quienes tbody");
      } else if (sectionId === "valores") {
        const title = document.getElementById("valores-title").value.trim();
        const body = document.getElementById("valores-body").value.trim();
        if (!title || !body) { alert("Completa t√≠tulo y descripci√≥n."); return; }
        payload = { title, body, userId: 1 };
        url = `${API}/posts`;
        tableBody = document.querySelector("#table-valores tbody");
      } else if (sectionId === "contacto") {
        const name = document.getElementById("contacto-name").value.trim();
        const phone = document.getElementById("contacto-phone").value.trim();
        if (!name || !phone) { alert("Completa nombre y tel√©fono."); return; }
        payload = { name, phone };
        url = `${API}/users`;
        tableBody = document.querySelector("#table-contacto tbody");
      } else if (sectionId === "portafolio") {
        const title = document.getElementById("portafolio-title").value.trim();
        const state = document.getElementById("portafolio-state").value.trim();
        if (!title || !state) { alert("Completa proyecto y estado."); return; }
        payload = { title, completed: /^fin(alizado)?$/i.test(state) };
        url = `${API}/todos`;
        tableBody = document.querySelector("#table-portafolio tbody");
      }

      try {
        statusEl.textContent = "Creando...";
        const res = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json; charset=UTF-8" },
          body: JSON.stringify(payload)
        });
        const created = await res.json();
        tableBody.insertAdjacentHTML("afterbegin", renderRow(sectionId, created));
        statusEl.textContent = "Creado (simulado).";
      } catch (e) {
        statusEl.textContent = "Error en creaci√≥n: " + e.message;
        alert("Error creando: " + e.message);
      }
    }

    // UPDATE
    async function editRow(sectionId, id) {
      const statusEl = document.getElementById("status-" + sectionId);
      const row = document.querySelector(`#${tableId(sectionId)} tbody tr[data-id="${id}"]`);
      if (!row) { alert("Fila no encontrada."); return; }

      let payload = {}, url = "";
      if (sectionId === "quienes") {
        const name = row.children[1].innerText.trim();
        const email = row.children[2].innerText.trim();
        payload = { name, email };
        url = `${API}/users/${id}`;
      } else if (sectionId === "valores") {
        const title = row.children[1].innerText.trim();
        const body = row.children[2].innerText.trim();
        payload = { title, body, userId: 1 };
        url = `${API}/posts/${id}`;
      } else if (sectionId === "contacto") {
        const name = row.children[1].innerText.trim();
        const phone = row.children[2].innerText.trim();
        payload = { name, phone };
        url = `${API}/users/${id}`;
      } else if (sectionId === "portafolio") {
        const title = row.children[1].innerText.trim();
        const state = row.children[2].innerText.trim();
        payload = { title, completed: /^fin(alizado)?$/i.test(state) };
        url = `${API}/todos/${id}`;
      }

      try {
        statusEl.textContent = "Actualizando...";
        const res = await fetch(url, {
          method: "PUT",
          headers: { "Content-Type": "application/json; charset=UTF-8" },
          body: JSON.stringify(payload)
        });
        const updated = await res.json();
        // Actualizamos celdas sin reemplazar toda la fila para no perder eventos
        updateRowCells(sectionId, row, updated);
        statusEl.textContent = "Actualizado (simulado).";
      } catch (e) {
        statusEl.textContent = "Error en actualizaci√≥n: " + e.message;
        alert("Error actualizando: " + e.message);
      }
    }

    function updateRowCells(sectionId, row, data) {
      if (sectionId === "quienes") {
        row.children[1].innerText = data.name ?? row.children[1].innerText;
        row.children[2].innerText = data.email ?? row.children[2].innerText;
      } else if (sectionId === "valores") {
        row.children[1].innerText = data.title ?? row.children[1].innerText;
        row.children[2].innerText = data.body ?? row.children[2].innerText;
      } else if (sectionId === "contacto") {
        row.children[1].innerText = data.name ?? row.children[1].innerText;
        row.children[2].innerText = data.phone ?? row.children[2].innerText;
      } else if (sectionId === "portafolio") {
        row.children[1].innerText = data.title ?? row.children[1].innerText;
        row.children[2].innerText = (data.completed ? "Finalizado" : "Pendiente");
      }
    }

    // DELETE
    async function deleteRow(sectionId, id) {
      const statusEl = document.getElementById("status-" + sectionId);
      const tableBody = document.querySelector(`#${tableId(sectionId)} tbody`);
      try {
        statusEl.textContent = "Eliminando...";
        const res = await fetch(`${endpoint(sectionId)}/${id}`, { method: "DELETE" });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const row = tableBody.querySelector(`tr[data-id="${id}"]`);
        if (row) row.remove();
        statusEl.textContent = "Eliminado (simulado).";
      } catch (e) {
        statusEl.textContent = "Error al eliminar: " + e.message;
        alert("Error eliminando: " + e.message);
      }
    }

    // Helpers
    function tableId(sectionId) {
      if (sectionId === "quienes") return "table-quienes";
      if (sectionId === "valores") return "table-valores";
      if (sectionId === "contacto") return "table-contacto";
      if (sectionId === "portafolio") return "table-portafolio";
      return "";
    }
    function endpoint(sectionId) {
      if (sectionId === "quienes") return `${API}/users`;
      if (sectionId === "valores") return `${API}/posts`;
      if (sectionId === "contacto") return `${API}/users`;
      if (sectionId === "portafolio") return `${API}/todos`;
      return API;
    }
    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, s => ({ "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#39;" }[s]));
    }

    // Inicializaci√≥n: observer y primera carga
    setupObserverForSection(document.getElementById("quienes"));
    loadAPIData("quienes");
  </script>
</body>
</html>
